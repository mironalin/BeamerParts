# BeamerParts - Phase 2: Core Business Logic

## Phase Overview

**Objective**: Implement essential e-commerce functionality within the established microservices architecture

**Duration**: 4-5 weeks

**Scope**: Build upon the Phase 1 foundation to create a fully functional e-commerce system with advanced business logic, cross-service data operations, and comprehensive error handling that enables users to browse, search, and manage products while maintaining data consistency across distributed services.

## Core Requirements

### Functional Requirements
- Advanced product catalog with sophisticated BMW compatibility filtering
- Comprehensive shopping cart functionality with cross-service validation
- Intelligent inventory management with real-time stock synchronization
- Enhanced user management with vehicle preferences and profiles
- Advanced product search with filtering, sorting, and BMW-specific queries
- Event-driven architecture for maintaining data consistency
- Robust error handling and service resilience patterns

### Technical Requirements
- Cross-service business logic implementation with proper error handling
- Advanced caching strategies for performance optimization
- Complex validation rules spanning multiple services
- Event-driven inventory updates and synchronization
- Circuit breakers and retry mechanisms for service resilience
- Comprehensive logging and monitoring for distributed operations
- Performance optimization for cross-service queries

## Enhanced Database Architecture

### User Service Database Enhancements

#### User Profile Extensions
```sql
-- Enhanced user profiles
ALTER TABLE users ADD COLUMN preferred_language VARCHAR(5) DEFAULT 'ro';
ALTER TABLE users ADD COLUMN timezone VARCHAR(50) DEFAULT 'Europe/Bucharest';
ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP;
ALTER TABLE users ADD COLUMN login_attempts INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN locked_until TIMESTAMP;

-- User preferences and settings
user_preferences (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    preference_key VARCHAR(100) NOT NULL,
    preference_value TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_user_preferences UNIQUE (user_id, preference_key)
);

-- User activity tracking
user_activity_log (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    activity_data JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT ck_activity_type CHECK (activity_type IN ('LOGIN', 'LOGOUT', 'CART_UPDATE', 'PROFILE_UPDATE', 'VEHICLE_ADDED'))
);
```

#### Advanced Cart Management
```sql
-- Enhanced cart with session tracking
ALTER TABLE cart_items ADD COLUMN session_id VARCHAR(255);
ALTER TABLE cart_items ADD COLUMN saved_for_later BOOLEAN DEFAULT false;
ALTER TABLE cart_items ADD COLUMN added_from_wishlist BOOLEAN DEFAULT false;

-- Cart sessions for guest users
cart_sessions (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    session_id VARCHAR(255) NOT NULL UNIQUE,
    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    is_active BOOLEAN DEFAULT true,
    
    CONSTRAINT ck_cart_session_expiry CHECK (expires_at > created_at)
);

-- Wishlist functionality
user_wishlists (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    product_sku VARCHAR(50) NOT NULL,
    variant_sku VARCHAR(20),
    added_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    notes TEXT,
    
    CONSTRAINT uk_user_wishlist_item UNIQUE (user_id, product_sku, variant_sku)
);
```

### Vehicle Service Database Enhancements

#### Advanced BMW Data Management
```sql
-- BMW model specifications
bmw_model_specifications (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    generation_id BIGINT NOT NULL REFERENCES bmw_generations(id),
    engine_code VARCHAR(20),
    engine_displacement INTEGER, -- in cubic centimeters
    fuel_type VARCHAR(20),
    drivetrain VARCHAR(10), -- RWD, FWD, AWD
    transmission_type VARCHAR(20),
    power_hp INTEGER,
    torque_nm INTEGER,
    year_start INTEGER,
    year_end INTEGER,
    is_active BOOLEAN DEFAULT true,
    
    CONSTRAINT ck_bmw_specs_fuel CHECK (fuel_type IN ('PETROL', 'DIESEL', 'HYBRID', 'ELECTRIC')),
    CONSTRAINT ck_bmw_specs_drivetrain CHECK (drivetrain IN ('RWD', 'FWD', 'AWD'))
);

-- Compatibility rules and constraints
compatibility_rules (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    generation_id BIGINT NOT NULL REFERENCES bmw_generations(id),
    rule_type VARCHAR(50) NOT NULL,
    rule_condition JSONB NOT NULL,
    rule_description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT ck_compatibility_rule_type CHECK (rule_type IN ('ENGINE_REQUIREMENT', 'YEAR_RESTRICTION', 'TRIM_SPECIFIC', 'FEATURE_DEPENDENT'))
);

-- Enhanced compatibility registry with validation
ALTER TABLE vehicle_compatibility_registry ADD COLUMN compatibility_score DECIMAL(3,2) DEFAULT 1.0;
ALTER TABLE vehicle_compatibility_registry ADD COLUMN installation_difficulty VARCHAR(20) DEFAULT 'EASY';
ALTER TABLE vehicle_compatibility_registry ADD COLUMN requires_coding BOOLEAN DEFAULT false;
ALTER TABLE vehicle_compatibility_registry ADD COLUMN warranty_impact VARCHAR(20) DEFAULT 'NONE';

-- Vehicle feature tracking
bmw_generation_features (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    generation_id BIGINT NOT NULL REFERENCES bmw_generations(id),
    feature_name VARCHAR(100) NOT NULL,
    feature_code VARCHAR(20),
    is_standard BOOLEAN DEFAULT false,
    is_optional BOOLEAN DEFAULT true,
    availability_years INTEGER[],
    
    CONSTRAINT uk_generation_feature UNIQUE (generation_id, feature_code)
);
```

### Product Service Database Enhancements

#### Advanced Product Management
```sql
-- Product specifications and attributes
product_attributes (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    attribute_name VARCHAR(100) NOT NULL,
    attribute_value TEXT NOT NULL,
    attribute_type VARCHAR(20) DEFAULT 'TEXT',
    display_order INTEGER DEFAULT 0,
    is_searchable BOOLEAN DEFAULT false,
    
    CONSTRAINT ck_attribute_type CHECK (attribute_type IN ('TEXT', 'NUMBER', 'BOOLEAN', 'COLOR', 'DIMENSION'))
);

-- Product bundles and kits
product_bundles (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    bundle_sku VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    bundle_price DECIMAL(10,2) NOT NULL,
    discount_percentage DECIMAL(5,2) DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

product_bundle_items (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    bundle_id BIGINT NOT NULL REFERENCES product_bundles(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    variant_id BIGINT REFERENCES product_variants(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 1,
    is_optional BOOLEAN DEFAULT false,
    
    CONSTRAINT ck_bundle_item_quantity CHECK (quantity > 0)
);

-- Advanced pricing rules
pricing_rules (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    rule_name VARCHAR(100) NOT NULL,
    rule_type VARCHAR(50) NOT NULL,
    target_type VARCHAR(20) NOT NULL, -- PRODUCT, CATEGORY, BUNDLE
    target_id BIGINT NOT NULL,
    condition_json JSONB,
    discount_type VARCHAR(20) NOT NULL,
    discount_value DECIMAL(10,2) NOT NULL,
    min_quantity INTEGER DEFAULT 1,
    max_quantity INTEGER,
    valid_from TIMESTAMP,
    valid_until TIMESTAMP,
    is_active BOOLEAN DEFAULT true,
    
    CONSTRAINT ck_pricing_rule_type CHECK (rule_type IN ('BULK_DISCOUNT', 'SEASONAL', 'CLEARANCE', 'LOYALTY')),
    CONSTRAINT ck_pricing_target_type CHECK (target_type IN ('PRODUCT', 'CATEGORY', 'BUNDLE')),
    CONSTRAINT ck_pricing_discount_type CHECK (discount_type IN ('PERCENTAGE', 'FIXED_AMOUNT'))
);
```

#### Enhanced Inventory Management
```sql
-- Advanced inventory tracking
ALTER TABLE inventory ADD COLUMN cost_price DECIMAL(10,2);
ALTER TABLE inventory ADD COLUMN supplier_sku VARCHAR(100);
ALTER TABLE inventory ADD COLUMN location_code VARCHAR(20) DEFAULT 'MAIN';
ALTER TABLE inventory ADD COLUMN expiry_date DATE;
ALTER TABLE inventory ADD COLUMN batch_number VARCHAR(50);

-- Inventory locations and warehouses
inventory_locations (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    location_code VARCHAR(20) NOT NULL UNIQUE,
    location_name VARCHAR(100) NOT NULL,
    address TEXT,
    is_active BOOLEAN DEFAULT true,
    capacity_limit INTEGER,
    current_capacity INTEGER DEFAULT 0
);

-- Supplier management
suppliers (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    supplier_code VARCHAR(20) NOT NULL UNIQUE,
    supplier_name VARCHAR(200) NOT NULL,
    contact_email VARCHAR(255),
    contact_phone VARCHAR(20),
    address TEXT,
    payment_terms VARCHAR(50),
    lead_time_days INTEGER DEFAULT 7,
    minimum_order_amount DECIMAL(10,2),
    is_active BOOLEAN DEFAULT true,
    rating DECIMAL(3,2) DEFAULT 5.0,
    
    CONSTRAINT ck_supplier_rating CHECK (rating >= 0 AND rating <= 5)
);

-- Purchase orders for inventory replenishment
purchase_orders (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    order_number VARCHAR(50) NOT NULL UNIQUE,
    supplier_id BIGINT NOT NULL REFERENCES suppliers(id),
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    order_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expected_delivery_date DATE,
    actual_delivery_date DATE,
    total_amount DECIMAL(10,2) NOT NULL,
    notes TEXT,
    
    CONSTRAINT ck_po_status CHECK (status IN ('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED'))
);

purchase_order_items (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    purchase_order_id BIGINT NOT NULL REFERENCES purchase_orders(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id),
    variant_id BIGINT REFERENCES product_variants(id),
    quantity_ordered INTEGER NOT NULL,
    quantity_received INTEGER DEFAULT 0,
    unit_cost DECIMAL(10,2) NOT NULL,
    
    CONSTRAINT ck_po_item_quantities CHECK (quantity_ordered > 0 AND quantity_received >= 0)
);
```

#### BMW Cache Enhancements
```sql
-- Enhanced BMW cache with features
ALTER TABLE bmw_generations_cache ADD COLUMN typical_features TEXT[];
ALTER TABLE bmw_generations_cache ADD COLUMN common_issues TEXT[];
ALTER TABLE bmw_generations_cache ADD COLUMN popularity_score DECIMAL(3,2) DEFAULT 5.0;

-- BMW compatibility cache with advanced rules
bmw_compatibility_cache (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    generation_code VARCHAR(20) NOT NULL,
    product_sku VARCHAR(50) NOT NULL,
    compatibility_score DECIMAL(3,2) NOT NULL DEFAULT 1.0,
    installation_difficulty VARCHAR(20) DEFAULT 'EASY',
    requires_coding BOOLEAN DEFAULT false,
    required_features TEXT[],
    incompatible_features TEXT[],
    installation_notes TEXT,
    last_verified TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_bmw_compat_cache UNIQUE (generation_code, product_sku),
    CONSTRAINT ck_compat_difficulty CHECK (installation_difficulty IN ('EASY', 'MODERATE', 'DIFFICULT', 'PROFESSIONAL'))
);
```

## Enhanced API Architecture

### Cross-Service Business Logic APIs

#### User Service Enhanced APIs
```http
# Advanced Authentication
POST /internal/auth/validate-session
POST /internal/auth/refresh-if-needed
PUT  /internal/auth/update-login-attempt

# User Preferences Management
GET    /internal/users/{userId}/preferences
PUT    /internal/users/{userId}/preferences
GET    /internal/users/{userId}/vehicles/recommended-products

# Enhanced Cart Operations
POST   /internal/users/{userId}/cart/validate-and-update
POST   /internal/users/{userId}/cart/apply-discounts
GET    /internal/users/{userId}/cart/recommendations
POST   /internal/users/{userId}/cart/save-for-later/{itemId}

# Wishlist Management
GET    /internal/users/{userId}/wishlist
POST   /internal/users/{userId}/wishlist/items
DELETE /internal/users/{userId}/wishlist/items/{itemId}
POST   /internal/users/{userId}/wishlist/move-to-cart/{itemId}

# User Activity Tracking
POST   /internal/users/{userId}/activity
GET    /internal/users/{userId}/activity/summary
```

#### Vehicle Service Enhanced APIs
```http
# Advanced BMW Data Queries
GET    /internal/generations/{generationCode}/specifications
GET    /internal/generations/{generationCode}/features
POST   /internal/generations/bulk-compatibility-check
GET    /internal/compatibility/rules/{ruleId}

# Product Compatibility Validation
POST   /internal/compatibility/validate-installation
GET    /internal/compatibility/{generationCode}/difficulty-rating
POST   /internal/compatibility/bulk-validate

# BMW Recommendations
GET    /internal/generations/{generationCode}/recommended-products
GET    /internal/generations/{generationCode}/popular-mods
POST   /internal/users/{userId}/vehicle-based-recommendations
```

#### Product Service Enhanced APIs
```http
# Advanced Product Queries
GET    /internal/products/by-bmw-generation/{generationCode}
POST   /internal/products/bulk-availability-check
GET    /internal/products/search/advanced
GET    /internal/products/{sku}/recommendations
GET    /internal/products/bundles

# Inventory Management
POST   /internal/inventory/reserve-multiple
POST   /internal/inventory/release-multiple
PUT    /internal/inventory/update-from-supplier
GET    /internal/inventory/low-stock-alerts

# Pricing and Discounts
POST   /internal/pricing/calculate-cart-total
GET    /internal/pricing/applicable-discounts
POST   /internal/pricing/apply-bulk-discount

# Product Attributes and Filtering
GET    /internal/products/attributes/searchable
POST   /internal/products/filter-by-attributes
GET    /internal/products/categories/{categoryId}/facets
```

### Enhanced API Gateway Routing

#### Smart Routing with Business Logic
```yaml
# Complex routing rules for business operations
spring:
  cloud:
    gateway:
      routes:
        # Multi-service cart operations
        - id: cart-validation-composite
          uri: http://user-service:8081
          predicates:
            - Path=/api/cart/validate-and-calculate
          filters:
            - name: CompositeCartFilter
              args:
                user-service-url: http://user-service:8081
                product-service-url: http://product-service:8083
                vehicle-service-url: http://vehicle-service:8082
        
        # BMW-specific product searches
        - id: bmw-product-search
          uri: http://product-service:8083
          predicates:
            - Path=/api/products/search/bmw/**
          filters:
            - StripPrefix=1
            - name: BMWCompatibilityFilter
              args:
                vehicle-service-url: http://vehicle-service:8082
        
        # User-specific recommendations
        - id: personalized-recommendations
          uri: http://user-service:8081
          predicates:
            - Path=/api/users/recommendations
          filters:
            - AuthenticationFilter
            - name: PersonalizationFilter
              args:
                product-service-url: http://product-service:8083
                vehicle-service-url: http://vehicle-service:8082
```

## Advanced Service Layer Architecture

### Cross-Service Business Logic Implementation

#### Advanced Cart Service (User Service)
```java
@Service
@Transactional
public class AdvancedCartService {
    
    @Autowired
    private ProductServiceClient productServiceClient;
    
    @Autowired
    private VehicleServiceClient vehicleServiceClient;
    
    @Autowired
    private PricingServiceClient pricingServiceClient;
    
    @CircuitBreaker(name = "cart-validation", fallbackMethod = "fallbackCartValidation")
    @Retryable(value = {ServiceUnavailableException.class}, maxAttempts = 3)
    public CartValidationResult validateAndUpdateCart(Long userId, CartValidationRequest request) {
        // 1. Get user's BMW vehicles for compatibility validation
        List<UserVehicle> userVehicles = userVehicleRepository.findByUserId(userId);
        
        // 2. Get current cart items
        List<CartItem> cartItems = cartItemRepository.findByUserId(userId);
        
        // 3. Validate each item against product service
        List<ProductValidationRequest> validationRequests = cartItems.stream()
                .map(this::mapToValidationRequest)
                .collect(Collectors.toList());
        
        ProductBulkValidationResponse productValidation = 
                productServiceClient.validateBulkProducts(validationRequests);
        
        // 4. Check BMW compatibility for user's vehicles
        List<CompatibilityCheckRequest> compatibilityRequests = createCompatibilityRequests(
                cartItems, userVehicles);
        
        CompatibilityBulkResponse compatibilityValidation = 
                vehicleServiceClient.validateBulkCompatibility(compatibilityRequests);
        
        // 5. Calculate pricing with applicable discounts
        PricingCalculationRequest pricingRequest = createPricingRequest(
                cartItems, productValidation, userId);
        
        PricingCalculationResponse pricingResponse = 
                pricingServiceClient.calculateCartPricing(pricingRequest);
        
        // 6. Update cart items based on validation results
        CartValidationResult result = processValidationResults(
                cartItems, productValidation, compatibilityValidation, pricingResponse);
        
        // 7. Save updated cart state
        updateCartItems(userId, result.getUpdatedItems());
        
        // 8. Publish cart updated event
        publishCartUpdatedEvent(userId, result);
        
        return result;
    }
    
    private CartValidationResult fallbackCartValidation(Long userId, 
            CartValidationRequest request, Exception ex) {
        log.warn("Cart validation failed for user {}, using cached data", userId, ex);
        return CartValidationResult.builder()
                .hasErrors(true)
                .errorMessage("Validation temporarily unavailable, please try again")
                .build();
    }
}
```

#### Advanced BMW Compatibility Service (Vehicle Service)
```java
@Service
public class AdvancedCompatibilityService {
    
    @Autowired
    private BMWGenerationRepository generationRepository;
    
    @Autowired
    private CompatibilityRulesRepository rulesRepository;
    
    @Autowired
    private VehicleSyncService syncService;
    
    public CompatibilityAnalysisResult analyzeProductCompatibility(
            String generationCode, String productSku, CompatibilityContext context) {
        
        // 1. Get BMW generation details
        BMWGeneration generation = generationRepository.findByCode(generationCode)
                .orElseThrow(() -> new GenerationNotFoundException(generationCode));
        
        // 2. Get product compatibility rules
        List<CompatibilityRule> rules = rulesRepository
                .findByGenerationIdAndIsActiveTrue(generation.getId());
        
        // 3. Analyze basic compatibility
        CompatibilityScore basicScore = calculateBasicCompatibility(generation, productSku);
        
        // 4. Apply advanced rules
        List<RuleEvaluationResult> ruleResults = rules.stream()
                .map(rule -> evaluateRule(rule, context))
                .collect(Collectors.toList());
        
        // 5. Calculate final compatibility score
        CompatibilityScore finalScore = calculateFinalScore(basicScore, ruleResults);
        
        // 6. Generate installation requirements
        InstallationRequirements requirements = generateInstallationRequirements(
                generation, productSku, ruleResults);
        
        // 7. Create compatibility warnings
        List<CompatibilityWarning> warnings = generateCompatibilityWarnings(
                ruleResults, requirements);
        
        return CompatibilityAnalysisResult.builder()
                .compatibilityScore(finalScore)
                .installationRequirements(requirements)
                .warnings(warnings)
                .recommendedFeatures(getRecommendedFeatures(generation, productSku))
                .estimatedInstallationTime(calculateInstallationTime(requirements))
                .build();
    }
    
    @EventListener
    @Async
    public void handleCompatibilityRuleUpdated(CompatibilityRuleUpdatedEvent event) {
        // Invalidate cached compatibility data
        // Notify Product Service of compatibility changes
        syncService.publishCompatibilityUpdateEvent(event);
    }
}
```

#### Advanced Product Search Service (Product Service)
```java
@Service
public class AdvancedProductSearchService {
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private BMWCacheService bmwCacheService;
    
    @Autowired
    private VehicleServiceClient vehicleServiceClient;
    
    @Cacheable(value = "product-search", key = "#searchRequest.cacheKey()")
    public ProductSearchResult searchProducts(AdvancedSearchRequest searchRequest) {
        
        // 1. Build base query with filters
        ProductSearchQuery baseQuery = buildBaseQuery(searchRequest);
        
        // 2. Apply BMW-specific filters if present
        if (searchRequest.hasBMWFilters()) {
            baseQuery = applyBMWFilters(baseQuery, searchRequest.getBmwFilters());
        }
        
        // 3. Apply attribute filters
        if (searchRequest.hasAttributeFilters()) {
            baseQuery = applyAttributeFilters(baseQuery, searchRequest.getAttributeFilters());
        }
        
        // 4. Execute search with pagination
        Page<Product> productPage = productRepository.findByAdvancedCriteria(
                baseQuery, searchRequest.getPageable());
        
        // 5. Enrich products with BMW compatibility data
        List<EnrichedProductDTO> enrichedProducts = enrichWithBMWData(
                productPage.getContent(), searchRequest.getUserVehicles());
        
        // 6. Calculate search facets for filtering
        SearchFacets facets = calculateSearchFacets(baseQuery, searchRequest);
        
        // 7. Generate product recommendations
        List<ProductRecommendationDTO> recommendations = generateRecommendations(
                enrichedProducts, searchRequest);
        
        return ProductSearchResult.builder()
                .products(enrichedProducts)
                .totalElements(productPage.getTotalElements())
                .facets(facets)
                .recommendations(recommendations)
                .searchMetadata(createSearchMetadata(searchRequest, baseQuery))
                .build();
    }
    
    private List<EnrichedProductDTO> enrichWithBMWData(List<Product> products, 
            List<UserVehicleDTO> userVehicles) {
        
        return products.stream()
                .map(product -> {
                    EnrichedProductDTO dto = mapToEnrichedDTO(product);
                    
                    // Add BMW compatibility information
                    if (!userVehicles.isEmpty()) {
                        List<CompatibilityInfo> compatibilityInfo = userVehicles.stream()
                                .map(vehicle -> checkCompatibility(product.getSku(), vehicle))
                                .collect(Collectors.toList());
                        dto.setCompatibilityInfo(compatibilityInfo);
                    }
                    
                    // Add installation information
                    dto.setInstallationInfo(getInstallationInfo(product.getSku()));
                    
                    return dto;
                })
                .collect(Collectors.toList());
    }
}
```

### Event-Driven Architecture Enhancements

#### Advanced Event Publishing
```java
@Component
public class BusinessEventPublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private ApplicationEventPublisher applicationEventPublisher;
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleCartUpdated(CartUpdatedEvent event) {
        // Publish to external services
        CartUpdateMessage message = CartUpdateMessage.builder()
                .userId(event.getUserId())
                .cartItems(event.getCartItems())
                .totalValue(event.getTotalValue())
                .timestamp(Instant.now())
                .build();
        
        rabbitTemplate.convertAndSend("user.cart.updated", message);
        
        // Trigger inventory checks if needed
        if (event.hasLowStockItems()) {
            rabbitTemplate.convertAndSend("inventory.check.required", 
                    event.getLowStockItems());
        }
    }
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleInventoryUpdated(InventoryUpdatedEvent event) {
        InventoryUpdateMessage message = InventoryUpdateMessage.builder()
                .productSku(event.getProductSku())
                .variantSku(event.getVariantSku())
                .oldQuantity(event.getOldQuantity())
                .newQuantity(event.getNewQuantity())
                .changeReason(event.getChangeReason())
                .timestamp(Instant.now())
                .build();
        
        rabbitTemplate.convertAndSend("product.inventory.updated", message);
        
        // Notify users with wishlist items if back in stock
        if (event.isBackInStock()) {
            rabbitTemplate.convertAndSend("user.wishlist.available", 
                    event.getProductSku());
        }
    }
}
```

### Advanced Validation Framework

#### Cross-Service Validation
```java
@Component
public class CrossServiceValidator {
    
    @Autowired
    private List<BusinessRuleValidator> validators;
    
    public ValidationResult validateBusinessRules(ValidationContext context) {
        ValidationResult.Builder resultBuilder = ValidationResult.builder();
        
        for (BusinessRuleValidator validator : validators) {
            if (validator.supports(context.getValidationType())) {
                ValidationResult individualResult = validator.validate(context);
                resultBuilder.addResult(individualResult);
                
                // Stop on critical errors
                if (individualResult.hasCriticalErrors()) {
                    break;
                }
            }
        }
        
        return resultBuilder.build();
    }
}

@Component
public class BMWCompatibilityValidator implements BusinessRuleValidator {
    
    @Override
    public ValidationResult validate(ValidationContext context) {
        if (context instanceof CartValidationContext) {
            return validateCartCompatibility((CartValidationContext) context);
        }
        return ValidationResult.success();
    }
    
    private ValidationResult validateCartCompatibility(CartValidationContext context) {
        ValidationResult.Builder result = ValidationResult.builder();
        
        for (CartItem item : context.getCartItems()) {
            for (UserVehicle vehicle : context.getUserVehicles()) {
                CompatibilityCheck check = checkItemVehicleCompatibility(item, vehicle);
                
                if (!check.isCompatible()) {
                    result.addError(ValidationError.builder()
                            .code("BMW_COMPATIBILITY_MISMATCH")
                            .message(String.format("Product %s is not compatible with %s %s", 
                                    item.getProductSku(), vehicle.getSeriesCode(), 
                                    vehicle.getGenerationCode()))
                            .field("cartItems[" + item.getId() + "]")
                            .severity(ErrorSeverity.WARNING)
                            .build());
                }
            }
        }
        
        return result.build();
    }
}
```

## Performance Optimization Strategies

### Advanced Caching Implementation
```java
@Configuration
@EnableCaching
public class CacheConfiguration {
    
    @Bean
    public CacheManager cacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
                .RedisCacheManagerBuilder
                .fromConnectionFactory(redisConnectionFactory())
                .cacheDefaults(cacheConfiguration());
        
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(10))
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
    
    @Bean
    public KeyGenerator customKeyGenerator() {
        return (target, method, params) -> {
            StringBuilder sb = new StringBuilder();
            sb.append(target.getClass().getSimpleName());
            sb.append(".");
            sb.append(method.getName());
            
            for (Object param : params) {
                sb.append("_");
                if (param != null) {
                    sb.append(param.toString());
                }
            }
            
            return sb.toString();
        };
    }
}

@Service
public class CacheWarmupService {
    
    @EventListener(ApplicationReadyEvent.class)
    public void warmupCaches() {
        log.info("Starting cache warmup...");
        
        // Warm up BMW data cache
        warmupBMWHierarchyCache();
        
        // Warm up popular products cache
        warmupPopularProductsCache();
        
        // Warm up compatibility cache
        warmupCompatibilityCache();
        
        log.info("Cache warmup completed");
    }
}
```

### Database Query Optimization
```java
@Repository
public class OptimizedProductRepository extends JpaRepository<Product, Long> {
    
    @Query("""
        SELECT p FROM Product p 
        LEFT JOIN FETCH p.images pi 
        LEFT JOIN FETCH p.variants pv 
        LEFT JOIN FETCH p.inventory inv 
        LEFT JOIN FETCH p.compatibility pc 
        LEFT JOIN FETCH pc.generation g 
        WHERE p.status = 'ACTIVE' 
        AND (:categoryId IS NULL OR p.category.id = :categoryId)
        AND (:generationCode IS NULL OR pc.generationCode = :generationCode)
        AND (:minPrice IS NULL OR p.basePrice >= :minPrice)
        AND (:maxPrice IS NULL OR p.basePrice <= :maxPrice)
        AND (:inStock IS NULL OR inv.quantityAvailable > 0)
        """)
    Page<Product> findProductsWithOptimizedFetching(
            @Param("categoryId") Long categoryId,
            @Param("generationCode") String generationCode,
            @Param("minPrice") BigDecimal minPrice,
            @Param("maxPrice") BigDecimal maxPrice,
            @Param("inStock") Boolean inStock,
            Pageable pageable);
    
    @Modifying
    @Query("""
        UPDATE Inventory SET quantityReserved = quantityReserved + :quantity 
        WHERE productId = :productId 
        AND (:variantId IS NULL OR variantId = :variantId)
        AND quantityAvailable >= :quantity
        """)
    int reserveInventory(@Param("productId") Long productId, 
                        @Param("variantId") Long variantId, 
                        @Param("quantity") Integer quantity);
}
```

## Implementation Milestones

### Milestone 1: Enhanced User Management (Week 1)
**Deliverables:**
- Advanced user profile management with preferences
- Enhanced cart functionality with session support
- User activity logging and security improvements
- Wishlist functionality implementation
- User vehicle management with BMW validation

**Success Criteria:**
- ✅ Users can manage detailed profiles and preferences
- ✅ Cart operations work across sessions (guest and authenticated)
- ✅ Wishlist functionality fully operational
- ✅ Security enhancements preventing brute force attacks

### Milestone 2: Advanced BMW Integration (Week 2)
**Deliverables:**
- Enhanced BMW data model with specifications and features
- Advanced compatibility rules and validation engine
- BMW-specific product recommendations
- Compatibility scoring and difficulty assessment
- Real-time BMW data synchronization improvements

**Success Criteria:**
- ✅ Complex BMW compatibility rules working correctly
- ✅ Accurate compatibility scoring for all products
- ✅ BMW-based product recommendations functional
- ✅ Vehicle Service events updating Product Service reliably

### Milestone 3: Advanced Product Operations (Week 3)
**Deliverables:**
- Sophisticated product search with multiple filters
- Product bundles and kit management
- Advanced pricing rules and bulk discounts
- Enhanced inventory management with supplier integration
- Product attribute system for detailed specifications

**Success Criteria:**
- ✅ Complex product searches returning accurate results
- ✅ Product bundles and pricing rules working correctly
- ✅ Inventory operations optimized for performance
- ✅ Product attributes enabling detailed filtering

### Milestone 4: Cross-Service Business Logic (Week 4)
**Deliverables:**
- Cart validation spanning multiple services
- Advanced event-driven architecture with reliable messaging
- Cross-service business rule validation
- Performance optimization with strategic caching
- Service resilience patterns (circuit breakers, retries)

**Success Criteria:**
- ✅ Cart validation checking stock, compatibility, and pricing
- ✅ Event-driven architecture maintaining data consistency
- ✅ All services resilient to network failures
- ✅ Response times optimized with effective caching

### Milestone 5: Integration Testing & Polish (Week 4-5)
**Deliverables:**
- Comprehensive cross-service integration testing
- Performance testing and optimization
- Advanced error handling and user feedback
- API documentation updates
- Monitoring and logging enhancements

**Success Criteria:**
- ✅ All cross-service operations thoroughly tested
- ✅ Performance targets met for complex operations
- ✅ Error scenarios handled gracefully with proper feedback
- ✅ Complete API documentation for enhanced endpoints

## Success Metrics

### Technical Performance
- **Cross-Service Response Time**: < 300ms for complex operations
- **Cache Hit Rate**: > 85% for frequently accessed data
- **Event Processing Time**: < 2 seconds for data synchronization
- **Service Availability**: 99.5%+ for each service during business operations

### Business Functionality
- **Cart Validation Accuracy**: 100% for stock and compatibility checks
- **Search Precision**: Relevant results for BMW-specific queries
- **Compatibility Accuracy**: Correct BMW compatibility for all products
- **Inventory Synchronization**: Real-time stock updates across services

### User Experience
- **Advanced Search Performance**: Sub-second response for complex queries
- **Cart Operations**: Seamless experience across guest and authenticated sessions
- **BMW Integration**: Accurate vehicle-specific product recommendations
- **Error Handling**: Clear, actionable error messages for business rule violations

---

**This Phase 2 implementation creates a sophisticated, production-ready e-commerce system with advanced business logic, cross-service integration, and comprehensive BMW compatibility features while maintaining the microservices architecture's benefits of scalability and maintainability.**